# å¾®ä¿¡è£‚å˜è®°å½•

åœºæ™¯ï¼šå·²å…³æ³¨ç”¨æˆ·å›å¤å…³é”®å­—è·å–è‡ªå·±çš„ä¸“å±æµ·æŠ¥ï¼Œé‚€è¯·ä»–äººæ‰«ç æµ·æŠ¥ï¼Œå¹¶å…³æ³¨æœ¬å…¬ä¼—å·ï¼Œä»¥è¾¾åˆ°å¾®ä¿¡ç²‰ä¸å¢é•¿çš„ç›®çš„ã€‚

è¿›è¡Œå¾®ä¿¡å¼€å‘ï¼Œé¦–å…ˆæ˜¯ï¼ŒåŸºæœ¬å¼€å‘ä¸­çš„æœåŠ¡å™¨é…ç½®ï¼Œå»ºè®®å¤§å®¶å‚è€ƒ[å…¥é—¨æŒ‡å¼•](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1472017492_58YV5 "å…¥é—¨æŒ‡å¼•")ï¼Œå¾ˆç®€å•ï¼Œå‚ç…§ç€è®¾ç½®ä¸€ä¸‹å¾ˆå¿«å°±å¥½äº†ã€‚ä¸è¿‡æœ€åè¦ç‚¹å‡»ä¸€ä¸‹å³ä¸Šè§’çš„â€œå¯ç”¨â€æŒ‰é’®ï¼Œå¦åˆ™ï¼Œå¾®ä¿¡æœåŠ¡å™¨æ¥å—ä¸åˆ°æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨çš„å“åº”ï¼Œå¯¼è‡´æˆ‘ä»¬çš„æœåŠ¡å™¨çš„urlè®¾ç½®ä¸æˆåŠŸã€‚æˆåŠŸä¹‹åçš„æˆªå›¾å¦‚ä¸‹ï¼š

![æœåŠ¡å™¨è®¾ç½®](../imgs/wxFansAdd/01_serverConfig.png)

ç„¶åè®¾ç½®å¥½access_token , å¾®ä¿¡å¼€å‘ç¦»ä¸å¼€access_tokençš„éªŒè¯ï¼Œæ‰èƒ½ä½¿ç”¨å¾®ä¿¡æä¾›çš„å„ç§æ¥å£ã€‚å¾®ä¿¡æœåŠ¡å™¨(å…¬ä¼—å¹³å°)ï¼Œè‡ªå·±çš„æœåŠ¡å™¨ï¼Œè‡ªå·±çš„é¡¹ç›®å‰å°çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![ä¸‰è€…å…³ç³»](../imgs/wxFansAdd/02_Relationship.png)

é…ç½®å¥½ç¯å¢ƒä¹‹åï¼Œå¯ä»¥å¼€å¼€å¿ƒå¿ƒçš„å¼€å‘å•¦ğŸ˜„

## ç¬¬ä¸€æ­¥ï¼Œæ¥å—åˆ°å…³æ³¨ç”¨æˆ·çš„è¯·æ±‚ã€‚

å¤„ç†ç”¨æˆ·çš„è¯·æ±‚çš„é€»è¾‘éƒ½åœ¨æœ¬æœåŠ¡å™¨ä¸­è¿›è¡Œï¼Œé‚£ä¹ˆå…ˆè¦è§£å†³çš„äº‹æƒ…æ˜¯æ€æ ·è®©æœåŠ¡å™¨æ¥æ”¶åˆ°ç”¨æˆ·çš„æ¶ˆæ¯å‘¢ï¼Ÿ
æˆ‘çš„åå°ä½¿ç”¨çš„æ˜¯koa2æ­å»ºçš„ï¼Œæ¥å—å¾®ä¿¡æœåŠ¡å™¨å‘æ¥çš„æ¶ˆæ¯éƒ½æ˜¯xmlæ ¼å¼çš„,ä½¿ç”¨parsePostDataå°±å¯ä»¥å¾—åˆ°å®Œæ•´çš„xmlæ•°æ®äº†ã€‚

``` js
// è§£æä¸Šä¸‹æ–‡é‡Œ node åŸç”Ÿè¯·æ±‚çš„ POST å‚æ•°
function parsePostData(ctx) {
    return new Promise((resovle, reject) => {
        try {
            let postData = "";
            //  ctx.req æ˜¯åŸç”Ÿ HTTP è¯·æ±‚å¯¹è±¡
            ctx.req.on("data", (data) => {
                postData += data;
            });
            ctx.req.on("end", () => {
                resovle(postData);
            })
        } catch (err) {
            reject(err);
        }
    });
}

```

## æ¥å—æ–‡æœ¬æ¶ˆæ¯

å½“ç”¨æˆ·åœ¨å…¬ä¼—å·çš„å¯¹è¯æ¡†ä¸­å‘é€ä»»ä½•æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬é…ç½®çš„æœåŠ¡å™¨éƒ½ä¼šæ”¶åˆ°æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨çš„xmlæ¶ˆæ¯ã€‚

``` xml
<xml>
 <ToUserName><![CDATA[gh_69b9829760d6]]></ToUserName>
 <FromUserName><![CDATA[o92L_1dye9BhzOpQEYARNLSgg0BM]]></FromUserName>
 <CreateTime>1538397268</CreateTime>
 <MsgType><![CDATA[text]]></MsgType>
 <Content><![CDATA[æ‰˜ç¦å¤‡è€ƒ]]></Content>
 <MsgId>6607365954744739874</MsgId>
</xml>

```

è§£é‡Šï¼š
createTime æ˜¯å¾®ä¿¡å…¬ä¼—å¹³å°è®°å½•ç²‰ä¸å‘é€è¯¥æ¶ˆæ¯çš„å…·ä½“æ—¶é—´

text: ç”¨äºæ ‡è®°è¯¥xml æ˜¯æ–‡æœ¬æ¶ˆæ¯ï¼Œä¸€èˆ¬ç”¨äºåŒºåˆ«åˆ¤æ–­

æ‰˜ç¦å¤‡è€ƒ: è¯´æ˜è¯¥ç²‰ä¸å‘ç»™å…¬ä¼—å·çš„å…·ä½“å†…å®¹æ˜¯æ‰˜ç¦å¤‡è€ƒ

MsgId: æ˜¯å…¬ä¼—å¹³å°ä¸ºè®°å½•è¯†åˆ«è¯¥æ¶ˆæ¯çš„ä¸€ä¸ªæ ‡è®°æ•°å€¼, å¾®ä¿¡åå°ç³»ç»Ÿè‡ªåŠ¨äº§ç”Ÿ

ä¸ºäº†æ–¹ä¾¿çš„è§£æXMLå†…å®¹ï¼Œæˆ‘ä½¿ç”¨äº†`xml2js`è¿™ä¸ªåŒ…ï¼Œå†™äº†ä¸€ä¸ªå‡½æ•°æ¥è§£ææ¥å—åˆ°çš„xmlæ•°æ®ã€‚

``` js
const {parseString} = require('xml2js');
function parseXML(xml) {
    try {
        return new Promise((resolve, reject) => {
            parseString(xml,  (err, result) => {
                err && console.log(err);
                resolve(result);
            })
        })
    }catch (e) {
        throw (e);
    }
}
```

å½“åˆ¤æ–­å¾—åˆ°ç”¨æˆ·å‘æ¥äº†å…³é”®å­—ä¹‹åï¼Œå°±è¦å›å¤ç”¨æˆ·ä¸€æ®µæ–‡å­—å’Œä¸€å¼ æµ·æŠ¥ï¼Œæˆ‘ä»¬å…ˆåšåˆ°å›å¤æ–‡å­—ã€‚

## è¢«åŠ¨å›å¤æ–‡æœ¬æ¶ˆæ¯

è¿™äº›å¼ºçƒˆæ¨èå…¥é—¨æŒ‡å¼•[https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1472017492_58YV5](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1472017492_58YV5)